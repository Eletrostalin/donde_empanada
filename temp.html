<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Map Application</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <meta name="language" content="ru">
</head>
<body>
    <div class="header">
        <img src="{{ url_for('static', filename='logo.png') }}" alt="Logo">
        {% if current_user.is_authenticated %}
            <div class="dropdown">
                <img src="{{ url_for('static', filename='profile.png') }}" alt="Profile" class="dropdown-toggle" onclick="toggleDropdown()">
                <div id="user-dropdown" class="dropdown-content">
                    <a href="#">Аккаунт</a>
                    <a href="{{ url_for('main.logout') }}">Выйти</a>
                </div>
            </div>
        {% else %}
            <div class="login-button" onclick="document.getElementById('login-modal').style.display='block'">Войти</div>
        {% endif %}
    </div>
    <div id="map"></div>
    <div class="custom-button-right" id="add-marker" onclick="document.getElementById('add-marker-modal').style.display='block'">
        <img src="{{ url_for('static', filename='add.png') }}" alt="Add Marker">
    </div>
    <div class="custom-button-right" id="my-location" style="top: 160px;">
        <img src="{{ url_for('static', filename='location.png') }}" alt="My Location">
    </div>

    <!-- Login Modal -->
    <div id="login-modal" class="modal">
        <div class="modal-content">
            <form id="login-form" action="{{ url_for('main.login') }}" method="post" onsubmit="handleLogin(event)">
                {{ form.hidden_tag() }}
                {{ form.csrf_token }}
                <input type="text" name="username" placeholder="Имя пользователя" required>
                <input type="password" name="password" placeholder="Пароль" required>
                <button type="submit">Войти</button>
                <button type="button" onclick="closeLoginForm()">Отмена</button>
                <div onclick="document.getElementById('registration-modal').style.display='block'; closeLoginForm();">Нет аккаунта?</div>
            </form>
        </div>
    </div>

    <!-- Registration Modal -->
    <div id="registration-modal" class="modal">
        <div class="modal-content">
            <form action="{{ url_for('main.register') }}" method="post">
                {{ form.hidden_tag() }}
                {{ form.csrf_token }}
                <input type="text" name="username" placeholder="Имя пользователя" required>
                <input type="text" name="first_name" placeholder="Имя" required>
                <input type="text" name="second_name" placeholder="Фамилия" required>
                <input type="email" name="email" placeholder="Электронная почта" required>
                <input type="text" name="phone" placeholder="Телефон" required>
                <input type="password" name="password" placeholder="Пароль" required>
                <input type="password" name="confirm_password" placeholder="Повторите пароль" required>
                <button type="submit">Зарегистрироваться</button>
                <button type="button" onclick="closeRegistrationForm()">Отмена</button>
            </form>
        </div>
    </div>

    <!-- Add Marker Modal -->
    <div id="add-marker-modal" class="modal">
        <div class="modal-content">
            <form action="{{ url_for('main.add_location') }}" method="post">
                {{ form.hidden_tag() }}
                {{ form.csrf_token }}
                <input type="text" name="name" placeholder="Название" required>
                <input type="text" name="description" placeholder="Описание" required>
                <input type="text" name="address" placeholder="Адрес" required>
                <input type="text" name="working_hours" placeholder="Часы работы" required>
                <input type="number" name="average_check" placeholder="Средний чек" required>
                <input type="hidden" name="latitude" id="latitude">
                <input type="hidden" name="longitude" id="longitude">
                <button type="submit">Добавить</button>
                <button type="button" onclick="closeAddMarkerForm()">Отмена</button>
            </form>
        </div>
    </div>

    <script>
        function toggleDropdown() {
            const dropdown = document.getElementById('user-dropdown');
            dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
        }

        async function handleLogin(event) {
            event.preventDefault();
            const form = event.target;
            const formData = new FormData(form);

            try {
                const response = await fetch(form.action, {
                    method: form.method,
                    body: formData,
                    headers: {
                        'X-CSRFToken': formData.get('csrf_token')
                    }
                });

                const result = await response.json();

                if (result.success) {

                    document.getElementById('login-modal').style.display = 'none';
                    location.reload(); // Перезагрузка страницы для обновления состояния авторизации
                } else {
                    alert(Ошибка входа: ${result.message});
                }
            } catch (error) {
                console.error('Ошибка:', error);
                alert('Произошла ошибка при входе. Пожалуйста, попробуйте снова.');
            }
        }

        async function handleRegistration(event) {
            event.preventDefault();
            const form = event.target;
            const formData = new FormData(form);

            try {
                const response = await fetch(form.action, {
                    method: form.method,
                    body: formData,
                    headers: {
                        'X-CSRFToken': formData.get('csrf_token')
                    }
                });

                const result = await response.json();

                if (result.success) {
                    showSuccessModal(result.message);  // Показать сообщение об успехе
                    setTimeout(() => {
                        document.getElementById('success-modal').style.display = 'none';
                        location.reload();  // Перезагрузка страницы через 2 секунды
                    }, 2000);
                } else {
                    alert(Ошибка регистрации: ${result.message});
                }
            } catch (error) {
                console.error('Ошибка:', error);
                alert('Произошла ошибка при регистрации. Пожалуйста, попробуйте снова.');
            }
        }

        function showSuccessModal(message) {
            const modal = document.getElementById('success-modal');
            const messageElement = document.getElementById('success-message');
            messageElement.textContent = message;
            modal.style.display = 'block';
        }

        function closeLoginForm() {
            document.getElementById('login-modal').style.display = 'none';
        }

        function closeRegistrationForm() {
            document.getElementById('registration-modal').style.display = 'none';
        }

        function closeAddMarkerForm() {
            document.getElementById('add-marker-modal').style.display = 'none';
        }

        function showRegistrationForm() {
            document.getElementById('login-modal').style.display = 'none';
            document.getElementById('registration-modal').style.display = 'block';
        }

        function initMap() {
            const map = new google.maps.Map(document.getElementById('map'), {
                center: { lat: -34.397, lng: 150.644 },
                zoom: 8,
                disableDefaultUI: true,  // Отключаем все кнопки
                zoomControl: true  // Включаем только управление зумом
            });
        }

        window.onclick = function(event) {
            const modals = ['login-modal', 'registration-modal', 'add-marker-modal'];
            modals.forEach(function(modal) {
                if (event.target == document.getElementById(modal)) {
                    document.getElementById(modal).style.display = "none";
                }
            });
        }
    </script>
    <script async
        src="https://maps.googleapis.com/maps/api/js?key={{ google_maps_api_key }}&callback=initMap"></script>
</body>
</html>